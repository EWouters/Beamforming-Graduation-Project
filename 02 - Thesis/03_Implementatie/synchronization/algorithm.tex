\documentclass[a4paper, notitlepage]{report}
\input{../title}
\input{../preamble}
\begin{document}

\section{Algorithm}
\label{sec:algorithm}
This section presents the two approaches for time offset correction that were implemented for this work. Both of these approaches rely on the transmission of a `beacon' signal with known properties, then correlating the received signals with this beacon. This technique is widely used in computing acoustic impulse responses \cite{Chu1990, MacWilliams1976}, and is a maximum-likelihood estimator for the delay between two sequences \cite{Knapp1976}.

\subsection{Time offset correction}
\subsubsection{Beacon signal}
\label{sec:mls}
In order to robustly estimate the time delay using cross correlation, it is desirable for the beacon signal to have four properties: first, the correlation operation should yield a prominent maximum when performed on the beacon signal, even when noise is introduced into the system. Second, the beacon should emit a wideband signal such that e.g. a resonant dip in acoustic frequency response will not disproportionately affect the synchronization procedure. Third, a long time support for the beacon lessens the effect of transient disturbances on the synchronization system. Finally, a low ratio of peak-to-average power is desirable, as it lowers demands on the audio playback and recording systems.

For this work, the decision was made to use a maximum length sequence (MLS). A maximum length sequence is a waveform generated by a linear feedback shift register (LFSR) designed to produce the longest possible sequence for a given amount of state information: with $N$ bits of state, it yields a sequence of length $2^N-1$. This sequence fits all four criteria listed above: its autocorrelation approaches the Kronecker delta function, it is spectrally flat in a wide frequency range (restricted by the signal's finite length and sample rate), the signal has configurable time support and finally a low ratio of peak-to-average power \cite{MacWilliams1976}. 

These properties of MLS make it a good candidate for (cross-)correlation processing, which is described below.

\subsubsection{Cross correlation}
Both the time- and frequency-domain synchronization algorithms rely on the operation of cross correlation. For discrete-time, real-valued signals, cross correlation is defined as follows \cite[p.~228]{Girod2001}:

\begin{equation}
\label{eq:cross-correlation}
(\vec{s} \star \vec{p})[n] = \vec{s}[-n]*\vec{p} = \sum_{m=-\infty}^{\infty} \vec{s}[m] \cdot \vec{p}[m+n]
\end{equation}

If $\vec{p}$ and $\vec{s}$ are the same maximum length sequence, this cross correlation approaches a delta function \cite{MacWilliams1976}:

$$ (\vec{s} \star \vec{p})[n] = (\vec{p} \star \vec{p})[n] \approx c \cdot \vec{\delta}[n] $$

where $c$ is a scaling factor dependent on the MLS amplitude and length.

If $\vec{s}$ is now convolved with an impulse response $\vec{h}$, the associativity and commutativity properties of convolution \cite[p.~169]{Girod2001} can be used to show that the cross correlation approaches that same response:

$$ \left((\vec{p} * \vec{h}) \star \vec{p}\right)[n] = (\vec{p} * \vec{h}) * \vec{h}[-n] = \vec{p}[-n] * \vec{p} * \vec{h} \approx c \cdot \vec{\delta} * \vec{h} = c \cdot \vec{h} $$

To implement both algorithms, a pulse signal $\vec{p}$ is first generated. This pulse is played back over a speaker to the phones, where each phone $i$ records an acquired signal $\vec{s}_i$. Each acquired signal is then the original pulse $\vec{p}$, convolved with an impulse response $\vec{h}_i$. This $\vec{h}_i$ represents the effects of the audio playback system, the room acoustics, the microphone response and the unsynchronized recording time offset:

$$ \vec{s}_i = \vec{p} * \vec{h}_i = \vec{p} * \vec{h}_{\text{speaker}} * \vec{h}_{\text{i,acoustic}} * \vec{h}_{\text{i,mic}} * \vec{h}_{\text{i,delay}} $$

It is assumed that each of the speaker and microphone impulse responses and the room impulse responses $\vec{h}_i$ consist of damped LTI systems. Although this assumption does not model all characteristics of room impulse responses, it is a common simplifying assumption in other literature \cite{Stan2002249}.

The LTI model predicts a prominent initial peak in $\vec{h}_i$. The acoustic impulse response is modelled with a propagation delay $t_p$, as well as damped repetitions resulting from surfaces in the room reflecting sound waves. The delay impulse response $\vec{h}_{\text{i,delay}}$ is assumed to contain only a time delay of $\Delta t_{\text{receive}}$, as explained in section \ref{sec:sro-problem}.

Based on these assumptions, the expected compound, time-domain impulse response consists of a prominent global maximum, and its scaled repetitions, smeared by the speaker and microphone impulse responses, and delayed by the combined propagation delay and time delay.

\subsubsection{Time-domain cross correlation}
The first implemented algorithm performs a time-domain cross correlation of $\vec{p}$ and $\vec{s}_i$ to obtain a signal $\vec{c}_i$ as in equation \ref{eq:cross-correlation}. This signal constitutes an estimate of the total system impulse response $\vec{h}_i$, and is expected to contain the same delayed global maximum described above. This maximum is located in each source signal $\vec{c}_i$ by a search, and its index $\hat{\tau}$ is used as an estimate of the total time delay $t_p + t_d$:

\begin{equation}
\hat{\tau} = \operatornamewithlimits{arg\,max}_n~(\vec{p} \star \vec{s}_i)[n]
\end{equation}

\subsubsection{Frequency-domain cross correlation}
\label{subsubsec:fd_algo}
In addition, a similar algorithm was implemented in the frequency domain to evaluate potential benefits.

First, both the pulse $\vec{p}$ and each recorded signal $\vec{s}_i$ are transformed by means of a fast Fourier transform (FFT) to yield signals $\vec{P}$ and $\vec{S}_i$ in the discrete-frequency domain. Next, these signals are cross correlated in the frequency domain. In the discrete-frequency domain, cross correlation can be written as an element-wise multiplication of the arguments \cite[p. 310]{Hansen2014}:

\begin{equation}
\label{eq:xcorr-fd}
\vec{s}_i \star \vec{p} = \vec{s}_i[-n] * \vec{p} ~\fourier ~\mathcal{F}\{\vec{s}_i \star \vec{p}\} = \vec{S} \odot \overline{\vec{P}}
\end{equation}

Since a time-domain delay $\tau$ maps to a linear phase shift $-2\pi k\tau/N$ in the discrete-frequency domain, the phase of the resultant signal consists of this frequency-dependent phase shift plus the phase of the input signal:

\begin{equation}
\label{eq:rir-influence-fd}
\vec{f}[t - \tau]~\fourier~e^{j \omega \tau} \mathcal{F} \{\vec{f}[t]\} \Rightarrow \arg(\mathcal{F} \{\vec{f}[t - \tau]\}) = \arg \left(\mathcal{F} \{\vec{f}[t]\}\right) - \frac{2\pi k}{N}~\tau
\end{equation}

where $2\pi k/N,~k \in \{0, 1 \dots ,N-1\}$ are the discrete frequencies. As a result, it is possible to estimate the delay $\tau$ by estimating the linear dependence of the phase shift on the frequency, so long as the phase contribution of the room impulse response, $\arg \left(\mathcal{F} \{\vec{f}[t]\}\right)$, is low compared to the delay-induced phase shift.

Therefore, the frequency-domain algorithm computes the phase angle of the frequency-domain cross correlation (equation \ref{eq:xcorr-fd}). Since this angle is confined to the interval $[-\pi, \pi]$, it is first `unwrapped' around each discontinuity to provide a linear phase $\vec{\phi} [n]$ as function of discrete frequencies. Then, the algorithm attempts a least-squares fit of a line $\vechat{\phi}[n] = n\hat{\Gamma}+\hat{\Theta}$. $\Gamma$ is then a measure for linear phase shift is computed as a slope in radians per FFT index. Finally, it is divided by $2\pi$ and multiplied by the FFT size $L$, to obtain corresponding time shift $\hat{\tau}$ measured in samples:

$$ \hat{\tau} = \hat{\Gamma} \cdot \frac{L}{2\pi} $$

\end{document}
